<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <style>
        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 16px #0001;
            padding: 0;
            display: flex;
            min-height: 600px;
            overflow: hidden;
        }
        .sidebar {
            width: 260px;
            background: #143a5a;
            color: #ffe08a;
            padding: 32px 18px 24px 18px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }
        .sidebar h2 {
            color: #ffe08a;
            font-size: 1.4em;
            margin: 0 0 18px 0;
            text-align: left;
        }
        #myLogin {
            margin-bottom: 18px;
            color: #ffe08a;
            font-size: 1.05em;
            word-break: break-all;
        }
        #chatsList {
            margin-bottom: 22px;
            flex: 1;
            overflow-y: auto;
        }
        .chat-btn {
            display: block;
            width: 100%;
            background: #ffe08a;
            color: #143a5a;
            border: none;
            border-radius: 7px;
            padding: 10px 8px;
            margin-bottom: 8px;
            font-size: 1em;
            text-align: left;
            cursor: pointer;
            transition: background 0.18s;
        }
        .chat-btn:hover, .chat-btn.active {
            background: #ffd700;
        }
        .main-block {
            flex: 1;
            padding: 36px 36px 24px 36px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .search-block {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .search-block input {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #d0d0d0;
            font-size: 1em;
        }
        .search-block button {
            background: #143a5a;
            color: #ffe08a;
            border: none;
            border-radius: 7px;
            padding: 10px 18px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.18s;
        }
        .search-block button:hover {
            background: #ffe08a;
            color: #143a5a;
        }
        #chatWith {
            font-size: 1.15em;
            color: #143a5a;
            margin-bottom: 8px;
            min-height: 24px;
        }
        .chat-block {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 16px;
            min-height: 220px;
            margin-bottom: 16px;
            background: #faf9f6;
            display: flex;
            flex-direction: column;
            height: 340px;
            max-height: 340px;
        }
        .messages {
            max-height: 220px;
            overflow-y: auto;
            margin-bottom: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .msg {
            padding: 8px 14px;
            border-radius: 14px;
            max-width: 70%;
            word-break: break-word;
            font-size: 1em;
            margin-bottom: 0;
            display: inline-block;
            align-self: flex-start;
            background: #ffe08a;
            color: #143a5a;
            box-shadow: 0 1px 4px #0001;
        }
        .msg.me {
            background: #143a5a;
            color: #fff;
            align-self: flex-end;
        }
        .msg.other {
            background: #ffe08a;
            color: #143a5a;
            align-self: flex-start;
        }
        .send-block {
            display: flex;
            gap: 8px;
        }
        .send-block input {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #d0d0d0;
            font-size: 1em;
        }
        .send-block button {
            background: #143a5a;
            color: #ffe08a;
            border: none;
            border-radius: 7px;
            padding: 10px 18px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.18s;
        }
        .send-block button:hover {
            background: #ffe08a;
            color: #143a5a;
        }
        #status {
            color: #d90000;
            min-height: 22px;
            margin-top: 6px;
        }
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                min-height: unset;
                max-width: 100vw;
                border-radius: 0;
                box-shadow: none;
            }
            .sidebar {
                width: 100%;
                flex-direction: row;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                padding: 14px 4vw 14px 4vw;
                align-items: flex-start;
                min-width: 0;
                box-sizing: border-box;
            }
            .sidebar h2 {
                font-size: 1.1em;
                margin-right: 12px;
                margin-bottom: 0;
                white-space: nowrap;
            }
            #myLogin {
                font-size: 0.98em;
                margin-bottom: 0;
                margin-right: 12px;
                white-space: nowrap;
            }
            #chatsList {
                margin-bottom: 0;
                max-height: 60px;
                overflow-x: auto;
                overflow-y: hidden;
                display: flex;
                flex-direction: row;
                gap: 6px;
                align-items: center;
                flex: 1;
            }
            .chat-btn {
                min-width: 90px;
                padding: 8px 10px;
                font-size: 0.98em;
                margin-bottom: 0;
                margin-right: 6px;
                border-radius: 7px;
                white-space: nowrap;
            }
            .main-block {
                padding: 16px 2vw 12px 2vw;
                min-width: 0;
            }
            .chat-block {
                padding: 10px 4px;
                min-height: 180px;
                height: 400px;         /* —É–≤–µ–ª–∏—á–µ–Ω–æ */
                max-height: 400px;     /* —É–≤–µ–ª–∏—á–µ–Ω–æ */
            }
            .messages {
                max-height: 300px;     /* —É–≤–µ–ª–∏—á–µ–Ω–æ */
                font-size: 0.98em;
            }
            .msg, .msg.me, .msg.other {
                font-size: 0.98em;
                padding: 7px 10px;
                border-radius: 12px;
                max-width: 90vw;
            }
            .search-block input, .send-block input {
                font-size: 1em;
                padding: 9px;
            }
            .search-block button, .send-block button {
                font-size: 1em;
                padding: 9px 12px;
            }
        }
        @media (max-width: 600px) {
            .container {
                max-width: 100vw;
                border-radius: 0;
                box-shadow: none;
            }
            .sidebar {
                padding: 8px 2vw 8px 2vw;
            }
            .main-block {
                padding: 8px 2vw 8px 2vw;
            }
            .chat-block {
                padding: 6px 2px;
                min-height: 120px;
                height: 320px;         /* —É–≤–µ–ª–∏—á–µ–Ω–æ */
                max-height: 320px;     /* —É–≤–µ–ª–∏—á–µ–Ω–æ */
            }
            .messages {
                max-height: 230px;     /* —É–≤–µ–ª–∏—á–µ–Ω–æ */
                font-size: 0.95em;
            }
            .msg, .msg.me, .msg.other {
                font-size: 0.95em;
                padding: 6px 8px;
                border-radius: 10px;
                max-width: 96vw;
            }
            .search-block input, .send-block input {
                font-size: 0.98em;
                padding: 8px;
            }
            .search-block button, .send-block button {
                font-size: 0.98em;
                padding: 8px 8px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
        <div id="myLogin"></div>
        <div id="chatsList"></div>
    </div>
    <div class="main-block">
        <div class="search-block" style="position:relative;">
            <input type="text" id="searchLogin" placeholder="–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <button id="findUserBtn">–ù–∞–π—Ç–∏</button>
            <div id="onlineUsersList" style="display:none; position:absolute; top:110%; left:0; right:0; background:#fff; border:1px solid #e0e0e0; border-radius:8px; z-index:10; max-height:220px; overflow-y:auto; box-shadow:0 2px 12px #0002;"></div>
        </div>
        <div id="chatWith"></div>
        <div class="chat-block" id="chatBlock" style="display:none;">
            <div class="messages" id="messages"></div>
            <div class="send-block">
                <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
        <div id="status"></div>
    </div>
</div>

<!-- Firebase App (core SDK) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<!-- Firebase Auth SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<!-- Firebase Firestore SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyAnDLe2RXvIdZBSE6cYrcq_3ENRQqVyMjY",
    authDomain: "goshack-4b984.firebaseapp.com",
    projectId: "goshack-4b984",
    storageBucket: "goshack-4b984.firebasestorage.app",
    messagingSenderId: "672350768641",
    appId: "1:672350768641:web:df83b4c4a64b3129cefa00",
    measurementId: "G-VZ0M6Z26ZQ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let chatUser = null;
let chatId = null;
let unsubscribe = null;

// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }
    currentUser = user;
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é users (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –±—ã–ª–æ)
    const userDoc = db.collection('users').doc(user.uid);
    const doc = await userDoc.get();
    if (!doc.exists) {
        await userDoc.set({
            uid: user.uid,
            login: user.displayName || "",
            email: user.email
        });
    }
    document.getElementById('myLogin').textContent = "–í–∞—à –ª–æ–≥–∏–Ω: " + (user.displayName || "(–Ω–µ –∑–∞–¥–∞–Ω)");
    loadChatsList();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
async function loadChatsList() {
    const chatsListDiv = document.getElementById('chatsList');
    chatsListDiv.innerHTML = "<b>–í–∞—à–∏ —á–∞—Ç—ã:</b><br>";
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
    const chatsSnap = await db.collection('user_chats').doc(currentUser.uid).get();
    if (!chatsSnap.exists || !chatsSnap.data().uids || chatsSnap.data().uids.length === 0) {
        chatsListDiv.innerHTML += "<span style='color:#aaa'>–ù–µ—Ç —á–∞—Ç–æ–≤</span>";
        return;
    }
    const uids = chatsSnap.data().uids;
    // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏–Ω—ã —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
    const usersSnap = await db.collection('users').where('uid', 'in', uids).get();
    usersSnap.forEach(doc => {
        const user = doc.data();
        const btn = document.createElement('button');
        btn.textContent = user.login || user.email;
        btn.className = 'chat-btn';
        btn.onclick = () => {
            chatUser = user;
            document.getElementById('chatWith').textContent = '–ß–∞—Ç —Å: ' + chatUser.login;
            document.getElementById('chatBlock').style.display = '';
            openChat();
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
            document.querySelectorAll('.chat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };
        chatsListDiv.appendChild(btn);
    });
}

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ª–æ–≥–∏–Ω—É
document.getElementById('findUserBtn').onclick = async function() {
    const login = document.getElementById('searchLogin').value.trim();
    document.getElementById('status').textContent = '';
    document.getElementById('chatWith').textContent = '';
    document.getElementById('chatBlock').style.display = 'none';
    if (!login) return;
    const q = await db.collection('users').where('login', '==', login).get();
    if (q.empty) {
        document.getElementById('status').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
        return;
    }
    chatUser = q.docs[0].data();
    if (chatUser.uid === currentUser.uid) {
        document.getElementById('status').textContent = '–ù–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ';
        return;
    }
    document.getElementById('chatWith').textContent = '–ß–∞—Ç —Å: ' + chatUser.login;
    document.getElementById('chatBlock').style.display = '';
    openChat();
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
    document.querySelectorAll('.chat-btn').forEach(b => {
        if (b.textContent === chatUser.login) b.classList.add('active');
        else b.classList.remove('active');
    });
};

// –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
async function openChat() {
    // chatId ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –ø–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, uid1_uid2 –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É)
    chatId = [currentUser.uid, chatUser.uid].sort().join('_');
    if (unsubscribe) unsubscribe();
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    unsubscribe = db.collection('chats').doc(chatId).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
            messagesDiv.innerHTML = '';
            snapshot.forEach(doc => {
                const msg = doc.data();
                const div = document.createElement('div');
                div.className = 'msg ' + (msg.from === currentUser.uid ? 'me' : 'other');
                div.textContent = msg.text;
                messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
document.getElementById('sendBtn').onclick = async function() {
    const text = document.getElementById('msgInput').value.trim();
    if (!text || !chatId) return;
    await db.collection('chats').doc(chatId).collection('messages').add({
        text,
        from: currentUser.uid,
        to: chatUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('msgInput').value = '';
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –¥—Ä—É–≥ –¥—Ä—É–≥—É –≤ user_chats
    const userChatsRef = db.collection('user_chats');
    await userChatsRef.doc(currentUser.uid).set({
        uids: firebase.firestore.FieldValue.arrayUnion(chatUser.uid)
    }, {merge:true});
    await userChatsRef.doc(chatUser.uid).set({
        uids: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    }, {merge:true});
    loadChatsList();
};

// 1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ —Å–µ—Ç–∏" (–æ–Ω–ª–∞–π–Ω)
// –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è "–≤ —Å–µ—Ç–∏", –µ—Å–ª–∏ –æ–±–Ω–æ–≤–∏–ª —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥

const ONLINE_TIMEOUT = 60 * 1000; // 60 —Å–µ–∫—É–Ω–¥

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    if (currentUser) {
        db.collection('users').doc(currentUser.uid).update({
            lastOnline: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}, 30000);

// –ü—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
firebase.auth().onAuthStateChanged(async user => {
    // ...—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥...
    if (user) {
        await db.collection('users').doc(user.uid).update({
            lastOnline: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
    // ...—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥...
});

// 2. –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–µ—Ç–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞

const searchInput = document.getElementById('searchLogin');
const onlineUsersList = document.getElementById('onlineUsersList');

searchInput.addEventListener('focus', async function() {
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ–Ω–ª–∞–π–Ω –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ –∏ –Ω–µ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const now = Date.now();
    const minTime = new Date(now - ONLINE_TIMEOUT);
    const usersSnap = await db.collection('users')
        .where('lastOnline', '>=', minTime)
        .get();
    let html = '';
    usersSnap.forEach(doc => {
        const user = doc.data();
        if (user.uid !== currentUser.uid && user.login) {
            html += `<div class="online-user-item" style="padding:9px 14px; cursor:pointer; border-bottom:1px solid #f0f0f0;" data-login="${user.login}">üü¢ ${user.login}</div>`;
        }
    });
    if (!html) html = `<div style="padding:9px 14px; color:#aaa;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–µ—Ç–∏</div>`;
    onlineUsersList.innerHTML = html;
    onlineUsersList.style.display = 'block';
});

// –°–∫—Ä—ã–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å)
searchInput.addEventListener('blur', function() {
    setTimeout(() => { onlineUsersList.style.display = 'none'; }, 150);
});

// –ö–ª–∏–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Äî –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
onlineUsersList.addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('online-user-item')) {
        searchInput.value = e.target.dataset.login;
        onlineUsersList.style.display = 'none';
        document.getElementById('findUserBtn').click();
    }
});

// 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ Enter
const msgInput = document.getElementById('msgInput');
msgInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('sendBtn').click();
    }
});
</script>
</body>
</html>